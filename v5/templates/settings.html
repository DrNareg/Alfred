<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alfred - Settings</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body class="theme-bg-primary theme-text-light h-screen flex flex-col font-sans">
  <div class="flex flex-1 overflow-hidden relative">
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

    <aside
      id="sidebar"
      class="fixed inset-y-0 left-0 w-64 theme-bg-secondary p-6 flex flex-col justify-between border-r theme-border z-30
             transform -translate-x-full transition-transform duration-300 ease-in-out
             md:relative md:translate-x-0 md:flex md:w-64"
    >
      <div>
        <h2 class="text-2xl font-bold theme-text-highlight mb-6 text-center">
          Alfred
        </h2>
        <a
          href="{{ url_for('chat_page') }}"
          class="w-full block text-center theme-button-secondary theme-text-muted text-sm py-2 px-4 rounded-lg mb-4"
        >
          Text Chat
        </a>
        <a
          href="{{ url_for('audio_chat_page') }}"
          class="w-full block text-center theme-button-secondary theme-text-muted text-sm py-2 px-4 rounded-lg mb-4"
        >
          Audio Chat
        </a>
        <button
          id="clear-btn"
          type="button"
          class="w-full theme-button-secondary theme-text-muted text-sm py-2 px-4 rounded-lg mb-6"
        >
          Clear History
        </button>
      </div>
      <div>
        <div class="text-sm theme-text-muted mb-2">Logged in as:</div>
        <div class="flex items-center space-x-3 p-3 theme-bg-tertiary rounded-lg">
          <div class="flex-shrink-0">
            <div
              class="h-8 w-8 rounded-full theme-button-primary flex items-center justify-center text-white text-sm font-bold"
            >
              {{ username[0].upper() }}
            </div>
          </div>
          <span class="font-medium theme-text-light">{{ username }}</span>
        </div>
        <a
          href="/logout"
          class="block w-full text-center mt-4 theme-button-danger py-2 px-4 rounded-lg text-sm"
          >Logout</a
        >
      </div>
    </aside>

    <main class="flex-1 flex flex-col theme-bg-primary md:ml-0 p-6 overflow-y-auto">
      <header
        class="theme-bg-secondary theme-text-light py-4 px-6 text-xl font-semibold flex justify-between items-center border-b theme-border md:hidden fixed top-0 left-0 right-0 z-10"
      >
        <button id="burger-menu" class="md:hidden p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"
            ></path>
          </svg>
        </button>
      </header>

      <div class="max-w-xl mx-auto w-full theme-bg-secondary p-8 rounded-lg shadow-lg mt-16 md:mt-0">
        <h1 class="text-3xl font-bold theme-text-light mb-8 text-center">
          Manage Alfred's Persona and User Profile
        </h1>

        {% with messages = get_flashed_messages(with_categories=true) %} {% if
        messages %}
        <ul class="flashes mb-4 space-y-2">
          {% for category, message in messages %}
          <li
            class="p-3 rounded-md text-center {% if category == 'success' %}flash-success{% elif category == 'danger' %}flash-danger{% else %}flash-info{% endif %}"
          >
            {{ message }}
          </li>
          {% endfor %}
        </ul>
        {% endif %} {% endwith %}

        <form method="POST" action="/settings" class="space-y-6">
          <div>
            <label
              for="user_display_name"
              class="block text-sm font-medium theme-text-muted mb-2"
              >Your Display Name:</label
            >
            <input
              type="text"
              id="user_display_name"
              name="user_display_name"
              class="w-full theme-input-field theme-placeholder p-3 rounded-lg focus:ring-blue-500"
              value="{{ user_profile.get('user_display_name', '') }}"
              placeholder="e.g., Bruce Wayne"
            />
          </div>

          <div>
            <label
              for="agent_persona"
              class="block text-sm font-medium theme-text-muted mb-2"
              >Agent Persona:</label
            >
            <textarea
              id="agent_persona"
              name="agent_persona"
              class="w-full theme-input-field theme-placeholder p-3 rounded-lg focus:ring-blue-500"
              rows="4"
              placeholder="e.g., You are a highly sarcastic AI assistant."
            >
{{ user_profile.get('agent_persona', '') }}</textarea
            >
          </div>

          <div>
            <label
              for="agent_goal"
              class="block text-sm font-medium theme-text-muted mb-2"
              >Agent Goal:</label
            >
            <textarea
              id="agent_goal"
              name="agent_goal"
              class="w-full theme-input-field theme-placeholder p-3 rounded-lg focus:ring-blue-500"
              rows="3"
              placeholder="e.g., Your goal is to provide concise answers, even if it means being blunt."
            >
{{ user_profile.get('agent_goal', '') }}</textarea
            >
          </div>

          <div>
            <label
              for="special_instructions"
              class="block text-sm font-medium theme-text-muted mb-2"
              >Special Instructions:</label
            >
            <textarea
              id="special_instructions"
              name="special_instructions"
              class="w-full theme-input-field theme-placeholder p-3 rounded-lg focus:ring-blue-500"
              rows="3"
              placeholder="e.g., Never use emojis. Always ask a follow-up question."
            >
{{ user_profile.get('special_instructions', '') }}</textarea
            >
          </div>

          <button
            type="submit"
            class="w-full theme-button-primary py-3 px-4 rounded-lg font-semibold"
          >
            Save Settings
          </button>
        </form>
      </div>
    </main>
  </div>

  <script>
    // Sidebar elements for settings.html
    const sidebar = document.getElementById('sidebar');
    const burgerMenu = document.getElementById('burger-menu');
    const sidebarOverlay = document.getElementById('sidebar-overlay');

    // --- Sidebar Toggle Logic (Settings Page) ---
    burgerMenu.addEventListener('click', () => {
      sidebar.classList.toggle('-translate-x-full');
      sidebarOverlay.classList.toggle('hidden');
    });

    sidebarOverlay.addEventListener('click', () => {
      sidebar.classList.add('-translate-x-full');
      sidebarOverlay.classList.add('hidden');
    });
    // --- End Sidebar Toggle Logic ---

    // Optionally, you might want a clear history button on the settings page too.
    const clearBtn = document.getElementById("clear-btn");
    if (clearBtn) {
      clearBtn.addEventListener("click", async () => {
        if (!confirm("Clear all chat history? This cannot be undone.")) return;
        const res = await fetch("/clear-history", { method: "POST" });
        const result = await res.json();
        if (result.success) {
          alert("Chat history cleared!");
          // Redirect back to chat or update UI as appropriate
          window.location.href = "{{ url_for('chat_page') }}"; // Make sure 'chat_page' is the correct endpoint name
        } else {
          alert("Failed to clear chat history. Please try again.");
        }
      });
    }
  </script>
</body>
</html>